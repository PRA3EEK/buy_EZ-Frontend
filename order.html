<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    .expiration input {
        border: 0;
        width: 50px;
    }

    #cardDetails>form {
        border: 1px solid;
        display: grid;
        grid-template-columns: 100%;
        width: 10%;
    }
    #paymentForm{
        padding: 10px;
        transform: translate(-50%, -50%);
        top: 50%;
        left: 50%;
        display: grid;
        grid-template-columns: 100%;
        width: 30%;
        border: 1px solid;
        position: absolute;
        border-radius: 5px;
        box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
        border: none;
        visibility: hidden;
    }
    #paymentForm input{
        /* border-radius: 5px; */
        margin-top: 10px;
        margin-bottom: 10px;
        height: 30px;
        font-size: 12px;
        border: none;
        border-bottom: 1px solid ;
    }
    #paymentForm input:focus
    {
        outline: none;
    }
    #expiry
    {
        width: 20%;
    }
    #cvv{
        width: 20%;
    }
    #top
    {
        /* border: 1px solid; */
        height: 50px;
        display: grid;
        grid-template-columns: 70% 20%;
        justify-content: space-between;
    }
    #cardImages{
        height: inherit;
        justify-content: space-between;
        align-items: center;
        /* border: 1px solid blue; */
        display: grid;
        grid-template-columns: repeat(3, 30%);
    }
    #visa, #maestro, #discover{
        width: 100%;
        /* border: 1px solid red; */
        
        
    }
    #MM-YY
    {
      display: flex;
    }
    #MM-YY>label{
        /* border: 1px solid red; */
        display: grid;
        justify-content: center;
        align-items: center;
    }
    #MM-YY>input{
        margin-right: 3%;
        margin-left: 5%;
        width: 20%;
    }
    #container{
        display: grid;
        grid-template-columns: 70% 30%;
    }
    #addressForm{
        display: grid;
        grid-template-columns: 100%;
        width: 30%;
    }
</style>

<body>



    


    <div id="container">
        <div id="left">
            <div id="defaultAddBox">
    
            </div>
            <button onclick="appear()">
                Add another address
            </button>
            <div id="addAddress">
        
        
            </div>
            <div id="paymentType">
                <p>Choose payment type</p>     
                <div id="types">
        
                </div>
            </div>
        </div>
        <div id="right">
            
        </div>
    </div>
   
    

 <div id="paymentFormDiv">
    <form action="" id="paymentForm">
        <div id="top">
            <h3 id="type">Debit Card</h3>
            <div id="cardImages">
                <img src="visa.png" alt="visa" id="visa">
                <img src="maestro.png" alt="maestro" id="maestro">
                <img src="discover.png" alt="discover" id="discover">
            </div>
        </div>
        <label for="cardNumber">Card Number</label>
        <input type="text" id="cardNumber" placeholder="Card Number" >
        <label for="cardName">Card holder name</label>
        <input type="text" id="cardName" placeholder="Card holder name">
        <p>Card Expiry</p>
        <div id="MM-YY">
            
            <label for="expiryMonth">Month</label><br>
            <input type="number" id="expiryMonth" placeholder="MM" maxlength="2"  oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"><br>
            <label for="expiryYear">Year</label><br>
            <input type="number" id="expiryYear" placeholder="YY" maxlength="2"  oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
        </div>
        <label for="cvv">CVV</label>
        <input type="number" id="cvv" placeholder="CVV" maxlength="3"  oninput="javascript: if(this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);">
        <input type="submit" value="Pay" onclick="placeOrder()">
    </form>
 </div>
    
    
          


          


    <div id="cardDetails">
        
    </div>
    
    <!-- <button id="proceed" onclick="proceed()">
        Place Order
    </button> -->

</body>

</html>

<script>

    var cookie = document.cookie;
    var address = null;
    var paymentType = 'Debit Card';
    if (cookie != "") {
        cookie = document.cookie.split("=")[1];
        fetch('http://localhost:8765/buy_EZ/user/details', {
            headers: {
                'Authorization': `Bearer ${cookie}`
            }
        }).then((response) => {
            if (response.ok) {
                return response.json();
            } else {
                return Promise.reject(response);
            }
        }).then((response) => {
            // console.log(response);
            
            var inputCheckbox = document.createElement('input');
            inputCheckbox.type = 'checkbox';
            inputCheckbox.value = `${response.address.details}, ${response.address.city}, ${response.address.state}, ${response.address.pincode}, ${response.country}`;
            inputCheckbox.id = 'defaultAddress';
            inputCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                
                    document.getElementById('addAddress').innerHTML = '';
                    address = response.address;
                    // console.log(address)
                }
            })
            var label = document.createElement('label')
            label.setAttribute('for', 'defaultAddress');
            label.innerText = `${response.address.details}, ${response.address.city}, ${response.address.state}, ${response.address.pincode}, ${response.country}`;
            document.getElementById('defaultAddBox').append(inputCheckbox, label);
        }).catch
            ((response) => {
                console.log('Error');
            })


        function appear() {
            document.getElementById('addAddress').innerHTML = "";
            document.getElementById('defaultAddress').checked = false;
            var addressForm = document.createElement('form');
            addressForm.id = 'addressForm';
            var state = document.createElement('input');
            state.setAttribute('required', '');
            state.placeholder = 'State'
            state.type = 'text';
            state.id = 'state';
            var city = document.createElement('input');
            city.setAttribute('required', '');
            city.placeholder = 'City'
            city.type = 'text';
            city.id = 'city';
            var pincode = document.createElement('input');
            pincode.setAttribute('required', '');
            pincode.placeholder = 'Pincode'
            pincode.type = 'number';
            pincode.id = 'pincode';
            var details = document.createElement('input');
            details.setAttribute('required', '');
            details.placeholder = 'Details'
            details.type = 'text';
            details.id = 'details';

            var addressSubmit = document.createElement('input');
            addressSubmit.id = 'addressSubmit';
            addressSubmit.value = 'Update Address'
            addressSubmit.type= 'submit'
             addressForm.addEventListener('submit', (e) => {
                e.preventDefault();
                address = {
                    state: state.value,
                    city : city.value,
                    details : details.value,
                    pincode : pincode.value
                }
                addressSubmit.value = 'Address Updated'
                // console.log(address);
                addressForm.reset();
                return false;
                
            })



            addressForm.append(state, city, pincode, details, addressSubmit);

            document.getElementById('addAddress').append(addressForm);
        }

        function paymentsAppear() {
            fetch('http://localhost:8765/buy_EZ/user/payments').then(response => {
                if (response.ok) {
                    return response.json();
                }
                else {
                    return Promise.reject(response);
                }
            }).then(response => {
                // console.log(response)
                let selectPayment = document.createElement('select');
                selectPayment.setAttribute('required', '')
                selectPayment.id = 'payment';

                let payments = response;
                for (let i = 0; i < payments.length; i++) {
                    let option = document.createElement('option');
                    option.value = payments[i].type;
                    if(i == 0)
                    {
                        option.setAttribute('selected', 'selected');
                    }
                    if (payments[i].allowed == 'No') {
                        option.setAttribute('disabled', '');
                    }
                    option.className = 'paymentOptions';
                    option.innerText = payments[i].type;
                    selectPayment.append(option);
                }
                selectPayment.addEventListener('change', () => 
                {
                    paymentType = selectPayment.value;
                    if(selectPayment.value != 'POD')
                    {
                        document.getElementById('type').innerText = selectPayment.value;
                    }
                })
                
                document.getElementById('types').append(selectPayment);
            })
        }
        paymentsAppear();

        function proceed() {
            document.getElementById('paymentForm').style.visibility= 'visible';
            
        }


  
            // console.log(address)
        
     
        document.getElementById('right').insertAdjacentHTML('afterBegin', ' <h1>Order Summary</h1><p id="items"></p><s><p id="totalAmount"></p></s><p id="payAmount"></p><p id="msg"></p><button id="checkout" onclick="proceed()">Checkout</button>');
        fetch('http://localhost:8765/buy_EZ/user/cart', {
            headers : {
                'Authorization':`Bearer ${cookie}`
            }
        }).then(response => {
            if(response.ok)
            {
            return response.json();
            }
        }).then(response => {
            // console.log(response)
         let itemNumber = response.numberOfItems;
         let totalAmount = response.totalAmount;
         let payAmount = response.payAmount;
         let save = response.save;
         document.getElementById('items').innerText = `Total items : ${itemNumber}`;
         document.getElementById('totalAmount').innerText = `Total amount : ₹ ${totalAmount}`;
         document.getElementById('payAmount').innerText = `Total amount to pay : ₹ ${payAmount}`;
         document.getElementById('msg').innerText = `You are saving : ₹ ${save}`;
        })



        //function to process order
        function placeOrder()
        {
           
            if(address===null || paymentType==null)
            {
                document.getElementById('paymentForm').style.visibility = 'hidden';
                alert('Please choose address and payment type you wish to pay with')
            }else{
                console.log(address);
                console.log(paymentType);
                fetch(`http://localhost:8765/buy_EZ/user/cart/order?paymentType=${paymentType}`, {
                method:'POST',
                body : JSON.stringify({
                    address: {
                        city : address.city,
                        state : address.state,
                        pincode : address.pincode,
                        details : address.pincode
                    }
                }),
                headers : {
                    'Authorization' : `Bearer ${cookie}`
                }
                }).then(response => {
                    if(response.ok)
                    {
                        return response.json();
                    }
                    else{
                        return Promise.reject(response);
                    }
                }).then(response => {
                    console.log(response);
                }).catch(response => {
                    console.log('ERROR');
                })
            }
        }
         
        //function to add dashes after every four characters in the card number input field
        document.getElementById('cardNumber').addEventListener('input', function () {
            if(this.value.length>19)
            {
                this.value = this.value.substring(0, 19);
            }
            var foo = this.value.split('-').join("");
            if(foo.length>0){
                foo = foo.match(new RegExp('.{1,4}', 'g')).join("-");
            }
            this.value = foo;
        })
       
    }

</script>